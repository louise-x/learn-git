name: Promote Prod Ver Workflow

on:
  workflow_dispatch: # Putting here is also fine!!

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  promote-stg-to-prod:
    # if: ${{ startsWith(github.ref, 'refs/heads/release/R') }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set Git config
      run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "Github Actions"
    - name: promote stg to prod
      run: |
        git fetch origin gitops
        git checkout origin/gitops stg-value.yaml
        git checkout origin/gitops version.yml
        cp stg-value.yaml prod-value.yaml
        git add .
        git diff-index --quiet HEAD || git commit -m "promote prod `git log -1 --pretty=format:'%s' origin/gitops -- stg-value.yaml`"
    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ github.token }}
        commit-message: promote stg to prod
        committer: GitHub <noreply@github.com>
        author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        signoff: false
        branch: promote-stg-to-prod
        delete-branch: true
        title: '[Example] promote stg to prod'
        body: |
          promote stg to prod
          - Updated with *today's* date
          - Auto-generated by [create-pull-request][1]
        assignees: ${{ github.actor }}
        reviewers: louise-x
        draft: false
    - name: Check outputs
      if: ${{ steps.cpr.outputs.pull-request-number }}
      run: |
        echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"