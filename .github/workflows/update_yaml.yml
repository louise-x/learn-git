name: GH-Receiver
 
on:
  repository_dispatch:
    types: [some_event]
 
jobs:
  receiver:
    runs-on: ubuntu-latest
    steps:
      - name: A event received
        run: |
          echo "payload Foo '${{ github.event.client_payload.foo }}'"
      - name: Check built-in kubectl
        run: kubectl version --client
      - name: Obtain Github Authentication Token
        id: create_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ vars.GH_APP_ID }}
          private_key: ${{ secrets.GH_PRIVATE_KEY }}
          # permissions: >-
          #   {"pull_requests": "write", "contents": "write", "actions": "write"}
      - name: Get token
        run: |
          echo "Token"
          echo ${{ steps.create_token.outputs.token }} | sed 's/./& /g'
      - name: Call API
        run: |
            curl -H "Accept: application/vnd.github+json" \
            -H "Authorization: token  ${{ steps.create_token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            --request POST \
            --data '{"body":"Here is the body for the review.","event":"APPROVE"}' https://api.github.com/repos/louise-x/my-terraform/pulls/1/reviews/1/events
      # - uses: actions/checkout@v4
      # - name: Create commits
      #   run: |
      #     git config user.name 'GH Actions Runner [bot]'
      #     git config user.email 'gh-actions-runner-bot@github.com'
      #     yq -i '.images[0].name = "${{ github.event.client_payload.foo }}"' stg-value.yaml
      #     git add -A
      #     git commit -m "Add test file during workflow"
      #     echo "app token ${{ steps.create_token.outputs.token }} "

      # - name: Create Pull Request
      #   id: cpr
      #   uses: peter-evans/create-pull-request@v6
      #   with:
      #     branch: test-stg-value
      #     labels: automerge
      #     token:  ${{ steps.create_token.outputs.token }}
      # - name: Check outputs
      #   if: ${{ steps.cpr.outputs.pull-request-number }}
      #   run: |
      #     echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
      #     echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
      #     echo "cpr actor is '${{ github.actor }}'"
      # - name: Auto approve
      #   uses: hmarr/auto-approve-action@v4
      #   # if: github.actor == 'ws-internal-tools[bot]'
      #   with:
      #     github-token: "${{ secrets.LX_PAT_TOKEN }}"
      #     pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
      # - name: Auto merge
      #   # if: success() && github.actor == 'ws-internal-tools[bot]'
      #   uses: pascalgn/automerge-action@v0.16.2
      #   env:
      #     GITHUB_TOKEN: " ${{ steps.create_token.outputs.token }} "
      #     PULL_REQUEST:  ${{ steps.cpr.outputs.pull-request-number }}